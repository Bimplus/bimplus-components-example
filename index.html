<!DOCTYPE html>
<html dir="ltr" lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="./styles.css"/>
    <link rel="shortcut icon" type="image/x-icon" href="/dist/assets/@bimplus/navigation/assets/favicon.ico">
    <title>Bimplus Component Example</title>
  </head>

  <body>
    <style>
      *,
      html {
        font-size: 100%;
        margin: 0;
        padding: 0;
      }

      html {
        font-size: 62.5%;
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100vw;

        position: fixed;
        overflow: hidden;
      }

      body {
        background-color: gray;
        margin: 0;
        font: normal 1.28rem "Source Sans Pro", Helvetica, Arial, tahoma,
          sans-serif !important;
      }

      bimplus-navigation-navbar {
        position: sticky;
        z-index: 4;
        box-shadow: 0 0.3rem 0.5rem 0 rgba(0, 0, 0, 0.26);
        display: block;
      }

      bimplus-navigation-main-menu {
        height: 100%;
        z-index: 4;
        position: sticky;
      }

      bimplus-navigation-main-menu.hidden {
        display: none;
      }

      bimplus-tool-hub {
        position: absolute;
        top: 300px;
        left: 300px;
      }

      bimplus-floating-bar-project-navigator {
        position: absolute;
        top: 600px;
        left: 600px;
        display: block; /*default it's shown*/
      }

      bimplus-floating-bar-hide-objects {
        position: absolute;
        top: 200px;
        left: 600px;
        display: none; /*default it's not shown*/
      }

      bimplus-floating-bar-isolation-objects {
        position: absolute;
        top: 300px;
        left: 600px;
        display: none; /*default it's not shown*/
      }

      bimplus-flat-tree {
        width: 100%;
        --flat-tree-folder-font-weight: 100;
      }

      bimplus-flat-tree.flat-tree div.tree-container {
        background-color: transparent;
      }

      .mainView {
        position: fixed;
        margin-top: 5.2rem;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <div>
      <!-- bimplus navbar is container for other components -->
      <bimplus-navigation-navbar
        team-info="Bimplus demo team"
        project-info="Quickstart project"
        is-dev
        is-navbar-menu-visible
      >
        <bimplus-context-menu
          show-icons="true"
          trigger-title="Custom context menu"
        ></bimplus-context-menu>

        <!-- storage info component -->
        <bimplus-navigation-storage-info
          selected-language="en"
          used-storage="80"
        ></bimplus-navigation-storage-info>

        <!-- contact component -->
        <bimplus-navigation-contact></bimplus-navigation-contact>

        <!-- touch menu component -->
        <bimplus-navigation-touch-menu selected-mode="desktop"></bimplus-navigation-touch-menu>

        <!-- language menu component -->
        <bimplus-navigation-language-menu selected-language="en"></bimplus-navigation-language-menu>

        <!-- user menu component -->
        <bimplus-navigation-user-menu user-name="Demo user"></bimplus-navigation-user-menu>
      </bimplus-navigation-navbar>

      <!-- bimplus main menu component -->
      <bimplus-navigation-main-menu
        project-name="00 Quickstart project"
        class="hidden"
        project-image-url="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTMS36RRWYaTysG471mlormL1bYN3-QIabbo30rDitKRoaDs3EA&s"
        is-dev
        show-overlay="false"
        is-collapsed="false"
        menu-active-item="bimexplorer"
      >
      </bimplus-navigation-main-menu>
    </div>

    <div class="mainView">
      <bimplus-sidenav>
        <bimplus-flat-tree
          enable-select="true"
          enable-parent-highlighting="true"
          multi-select="true"
          one-level-multi-select="false"
          show-folders-icons="true"
          show-objects-icons="true"
          enable-drag-and-drop="true"
          tree-title="FLAT TREE"
          tree-data-stringified='[{"name":"Folders3","id":"dbc08cd2-9f50-465b-9b54-da29c4988d07-00","parent":"dbc08cd2-9f50-465b-9b54-da29c4988d07","children":[{"name":"Folder 1","id":"dbc08cd2-9f50-465b-9b54-da29c4988d07-01","parent":"dbc08cd2-9f50-465b-9b54-da29c4988d07-00","children":[{"name":"Folder 1 - 1","id":"dbc08cd2-9f50-465b-9b54-da29c4988d07-02","parent":"dbc08cd2-9f50-465b-9b54-da29c4988d07-01","children":[{"name":"File 1 - 1 - 1","id":"dbc08cd2-9f50-465b-9b54-da29c4988d07-03","parent":"dbc08cd2-9f50-465b-9b54-da29c4988d07-02"},{"name":"File 1 - 1 - 2","id":"dbc08cd2-9f50-465b-9b54-da29c4988d07-04","parent":"dbc08cd2-9f50-465b-9b54-da29c4988d07-02"},{"name":"File 1 - 1 - 3","id":"dbc08cd2-9f50-465b-9b54-da29c4988d07-05","parent":"dbc08cd2-9f50-465b-9b54-da29c4988d07-02"}]},{"name":"File 1 - 2","id":"dbc08cd2-9f50-465b-9b54-da29c4988d07-06","parent":"dbc08cd2-9f50-465b-9b54-da29c4988d07-01"},{"name":"File 1 - 3","id":"dbc08cd2-9f50-465b-9b54-da29c4988d07-07","parent":"dbc08cd2-9f50-465b-9b54-da29c4988d07-01"}]},{"name":"Folder 4","id":"dbc08cd2-9f50-465b-9b54-da29c4988d07-22","parent":"dbc08cd2-9f50-465b-9b54-da29c4988d07-00","children":[]},{"name":"Folder 5","id":"dbc08cd2-9f50-465b-9b54-da29c4988d07-23","parent":"dbc08cd2-9f50-465b-9b54-da29c4988d07-00","children":[{"name":"File 3 - 3 - 3","id":"dbc08cd2-9f50-465b-9b54-da29c4988d07-24","parent":"dbc08cd2-9f50-465b-9b54-da29c4988d07-23"}]}]}]'
          class="flat-tree"
        >
        </bimplus-flat-tree>
      </bimplus-sidenav>

      <bimplus-tool-hub selected-language="en"></bimplus-tool-hub>

      <bimplus-floating-bar-project-navigator
        selected-language="en"
        (actionClicked)="actionClicked($event)"
      ></bimplus-floating-bar-project-navigator>

      <bimplus-floating-bar-hide-objects
        selected-language="en"
        (actionClicked)="actionClicked($event)"
      ></bimplus-floating-bar-hide-objects>

      <bimplus-floating-bar-isolation-objects
        selected-language="en"
        (actionClicked)="actionClicked($event)"
      ></bimplus-floating-bar-isolation-objects>
    </div>

    <script
      src="bimplus-components/polyfills.js"
      type="module"
    ></script>
    <script
      src="bimplus-components/main.js"
      type="module"
    ></script>
    <script
      src="bimplus-components/polyfills.js"
      type="module"
    ></script>
    <script
      src="bimplus-components/main.js"
      type="module"
    ></script>
    <script type="module" src="/dist/assets/@bimplus/navigation/polyfills.js"></script>
    <script type="module" src="/dist/assets/@bimplus/navigation/main.js"></script>

    <script>
      // language menu script
      const navbar = document.querySelector("bimplus-navigation-navbar");
      const storageInfo = document.querySelector("bimplus-navigation-storage-info");
      const contact = document.querySelector("bimplus-navigation-contact");
      const touchMenu = document.querySelector("bimplus-navigation-touch-menu");
      const lanMenu = document.querySelector("bimplus-navigation-language-menu");
      const userMenu = document.querySelector("bimplus-navigation-user-menu");

      const mainMenu = document.querySelector("bimplus-navigation-main-menu");
      const sidenav = document.querySelector("bimplus-sidenav");
      const toolHub = document.querySelector("bimplus-tool-hub");

      const projectNavigatorFloatingBar = document.querySelector(
        "bimplus-floating-bar-project-navigator"
      );
      const isolateObjectsFloatingBar = document.querySelector(
        "bimplus-floating-bar-hide-objects"
      );
      const hideObjectsFloatingBar = document.querySelector(
        "bimplus-floating-bar-isolation-objects"
      );

      let localizedStrings;

      let sideNavbarItems = [
        {
          id: "ObjectNavigator",
          icon: "./assets/images/ObjectManager_20_white.svg",
          iconActive: "./assets/images/ObjectManager_20_maincolor.svg",
          iconDisabled: "./assets/images/ObjectManager_20_disabled.svg",
          text: "_Object navigator",
        },
      ];

      let sideNavbarActionItems = [
        {
          id: "ViewportSettings",
          icon: "./assets/images/bimplus_WebIcons_Settings_White.svg",
          text: "Settings",
        },
      ];

      let sideNavbarFooterItem = {
        id: "shopLink",
        icon: "./assets/images/GetMore_20_white.svg",
        text: "Allplan Shop",
      };

      sidenav.items = sideNavbarItems;
      sidenav.actionItems = sideNavbarActionItems;
      sidenav.footerItem = sideNavbarFooterItem;

      let isolationObjectFloatingBarItems = [
        {
          buttonId: "cmbIsolateNormal",
          iconClass: "ui-icon-isolate-menu-normal",
          title: "_Isolate",
          active: true, // very first time this button is active
        },
        {
          buttonId: "cmbIsolateClipped",
          iconClass: "ui-icon-isolate-menu-clipped",
          title: "_Clipped_isolate",
          active: false,
        },
        {
          buttonId: "cmbIsolateHidden",
          iconClass: "ui-icon-isolate-menu-hidden",
          title: "_Hidden_isolate",
          active: false,
        },
      ];
      let hideObjectsFloatingBarItems = [
        {
          buttonId: "cmButObjHide",
          iconClass: "ui-icon-hide-object",
          title: "_Hide object",
          active: true, // very first time this button is active
        },
        {
          buttonId: "cmButObjTransp",
          iconClass: "ui-icon-transparent-object",
          title: "_Transparent_object",
          active: false,
        },
        {
          buttonId: "cmbButObjHideRestore",
          iconClass: "ui-icon-restore-hide-object",
          title: "_Restore_Hide",
          active: false,
        },
      ];
      isolateObjectsFloatingBar.items = isolationObjectFloatingBarItems;
      hideObjectsFloatingBar.items = hideObjectsFloatingBarItems;

      navbar.addEventListener("bimplusNavbarClicked", (event) => {
        alert(`Navbar clicked. Clicked on: ${event.detail}`);

        if (event.detail === "menu") {
          mainMenu.classList.toggle("hidden");
        }
      });

      // another way of communication is to capture events
      storageInfo.addEventListener("bimplusStorageInfoClicked", (event) => {
        // Print info
        //console.log(`EVENT : bimplusStorageInfoClicked. VALUE: ${event.detail}`);
        alert(`This is storage info action handler ${event.detail}`);
      });

      contact.addEventListener("bimplusContactClicked", (event) => {
        // Print info
        // console.log(`EVENT : bimplusContactClicked. VALUE: ${event.detail}`);
        alert(`This is contact action handler ${event.detail}`);
      });

      touchMenu.addEventListener("bimplusTouchModeSelected", (event) => {
        var isTouch = event.detail === "touch";
        alert(`EVENT : bimplusTouchModeSelected. VALUE: ${event.detail}`);
        touchMenu.setAttribute("selected-Mode", event.detail);
        navbar.setAttribute("is-touch", isTouch);
        mainMenu.setAttribute("is-touch", isTouch);
        userMenu.setAttribute("is-touch", isTouch);
      });

      userMenu.addEventListener("bimplusLanguageSelected", (e) => loadLanguage(e));
      lanMenu.addEventListener("bimplusLanguageSelected", (e) => loadLanguage(e));

      const loadLanguage = (event) => {
        alert(`EVENT : bimplusLanguageSelected. VALUE: ${event.detail}`);
        
        var req = new XMLHttpRequest();
        req.responseType = "json";
        req.open("GET", `/dist/assets/@bimplus/navigation/languages/strings_${event.detail}.json`, true);
        req.onload = function () {
          localizedStrings = req.response;
          mainMenu.localizedStrings = localizedStrings;
          sidenav.localizedStrings = localizedStrings;
          lanMenu.localizedStrings = localizedStrings;
          userMenu.localizedStrings = localizedStrings;
          touchMenu.localizedStrings = localizedStrings;
          storageInfo.localizedStrings = localizedStrings;
          toolHub.localizedStrings = localizedStrings;
          projectNavigatorFloatingBar.localizedStrings = localizedStrings;
          isolateObjectsFloatingBar.localizedStrings = localizedStrings;
          hideObjectsFloatingBar.localizedStrings = localizedStrings;

          mainMenu.setAttribute("selected-language", event.detail);
          sidenav.setAttribute("selected-language", event.detail);
          lanMenu.setAttribute("selected-language", event.detail);
          userMenu.setAttribute("selected-language", event.detail);
          touchMenu.setAttribute("selected-language", event.detail);
          storageInfo.setAttribute("selected-language", event.detail);
          toolHub.setAttribute("selected-language", event.detail);
          projectNavigatorFloatingBar.setAttribute("selected-language", event.detail);
          isolateObjectsFloatingBar.setAttribute("selected-language", event.detail);
          hideObjectsFloatingBar.setAttribute("selected-language", event.detail);
        };
        req.send(null);
      }

      userMenu.addEventListener("bimplusUserMenuClicked", (event) => {
        alert(
          `EVENT : bimplusUserMenuClicked. INDEX: ${event.detail.index} ACTION: ${event.detail.action}`
        );
      });

      mainMenu.addEventListener("bimplusMainMenuClicked", (event) => {
        alert(
          `EVENT : bimplusMainMenuClicked. ACTION: ${event.detail.action} TYPE: ${event.detail.type}`
        );
      });

      mainMenu.addEventListener("bimplusMainMenuOverlayClicked", (event) => {
        alert(`EVENT : bimplusMainMenuOverlayClicked.`);
      });

      // All states are false by default
      // Set the project navigation bar to active so it will be shown
      // Set the disabled state for usable floating bars to false
      let itemStates = [
        { buttonId: "cmButProjectNavigator", active: true, disabled: false },
        { buttonId: "cmButObjTranspMenu", disabled: false },
        { buttonId: "cmButObjSel", disabled: false },
        { buttonId: "cmButResetObj", disabled: false },
        { buttonId: "cmButResetVp", disabled: false },
      ];
      toolHub.itemStates = itemStates;

      let toggleActiveState = function (buttonId, newActiveState) {
        toolHub.itemStates = [{ buttonId: buttonId, active: newActiveState }];
      };

      toolHub.addEventListener("itemClicked", (event) => {
        console.debug(
          `toolHubItemClickedHandler called with item = ${event.detail}`,
          event,
          toolHub
        );

        switch (event.detail) {
          case "cmButResetObj":
            /* do some business logic here and return so no toggle called*/ return;
          case "cmButResetVp":
            toolHub?.toggleSubItemsView(event.detail);
            return;
          case "cmButObjTranspMenu":
            handleHideObjectsFloatingBarClicked();
            return;
          case "cmButObjSel":
            handleIsolationObjectsFloatingBarClicked();
            return;
          case "cmButProjectNavigator":
            handleProjectNavigatorClicked();
            return;
          default:
            alert("Handler not implemented for " + event.detail);
            break;
        }
      });
      toolHub.addEventListener("subItemClicked", (event) => {
        console.debug(
          `toolHubSubItemClickedHandler called with item = ${event.detail}`,
          event
        );
      });

      // #region Hide object floating bar
      let isFloatingBarHideObjectsVisible = false; // Set this flag based on your logic
      let handleHideObjectsFloatingBarClicked = function () {
        isFloatingBarHideObjectsVisible = !isFloatingBarHideObjectsVisible;
        if (isFloatingBarHideObjectsVisible) {
          hideObjectsFloatingBar.style.display = "block"; // Show the element
        } else {
          hideObjectsFloatingBar.style.display = "none"; // Hide the element
        }
        toggleActiveState(
          "cmButObjTranspMenu",
          isFloatingBarHideObjectsVisible
        );
      };

      hideObjectsFloatingBar.addEventListener("actionClicked", (event) => {
        const item = event.detail;
        switch (item) {
          case "cmButObjHide":
            hideObjectsFloatingBarItems[0].active = true;
            hideObjectsFloatingBarItems[1].active = false;
            break;
          case "cmButObjTransp":
            hideObjectsFloatingBarItems[0].active = false;
            hideObjectsFloatingBarItems[1].active = true;
            break;
          case "cmbButObjHideRestore":
          default:
            break;
        }

        // Reset new floating bar button states
        hideObjectsFloatingBar.items = hideObjectsFloatingBarItems;
      });
      // #endregion

      // #region Isolate objects floating bar
      let isFloatingBarIsolationObjectsVisible = false; // Set this flag based on your logic
      let handleIsolationObjectsFloatingBarClicked = function () {
        isFloatingBarIsolationObjectsVisible =
          !isFloatingBarIsolationObjectsVisible;
        if (isFloatingBarIsolationObjectsVisible) {
          isolateObjectsFloatingBar.style.display = "block"; // Show the element
        } else {
          isolateObjectsFloatingBar.style.display = "none"; // Hide the element
        }
        toggleActiveState("cmButObjSel", isFloatingBarIsolationObjectsVisible);
      };

      isolateObjectsFloatingBar.addEventListener("actionClicked", (event) => {
        const item = event.detail;
        // Set correct activation state of buttons of floating toolbar
        isolationObjectFloatingBarItems.forEach((barItem) => {
          if (barItem.buttonId === item) {
            barItem.active = true;
          } else if (barItem.active === true) {
            barItem.active = false;
          }
        });

        // Reset new floating bar button states
        isolateObjectsFloatingBar.items = isolationObjectFloatingBarItems;
      });
      // #endregion

      // #region Project navigator floating bar
      let isFloatingBarProjectNavigatorVisible = true; // Set this flag based on your logic
      let handleProjectNavigatorClicked = function () {
        isFloatingBarProjectNavigatorVisible =
          !isFloatingBarProjectNavigatorVisible;
        if (isFloatingBarProjectNavigatorVisible) {
          projectNavigatorFloatingBar.style.display = "block"; // Show the element
        } else {
          projectNavigatorFloatingBar.style.display = "none"; // Hide the element
        }
        toggleActiveState(
          "cmButProjectNavigator",
          isFloatingBarProjectNavigatorVisible
        );
      };

      projectNavigatorFloatingBar.addEventListener("actionClicked", (event) => {
        alert(
          `Action clicked for project navigator. Clicked on: ${event.detail}`
        );
      });

      let archModel = {
        id: "550e8400-e29b-41d4-a716-446655440001",
        name: "Architectural Model",
        currentRevision: 3,
        latestRevision: 5,
        isExpanded: true,
        divisionTopologyId: "550e8400-e29b-41d4-a716-446655440002",
        isVisible: true,
        opacity: 1.0,
        userOpacity: null,
        isOpaque: true,
      };

      let archModelLayers = [
        {
          id: "0f106af0-a919-44c5-b211-15bd5ef620b6",
          name: "Building Layer",
          opacity: 1.0,
          userOpacity: null,
          isVisible: true,
          isOpaque: true,
          parentModel: archModel
        },
        {
          id: "11555f6f-10ec-4180-88b3-699738c079c3",
          name: "Door Window",
          opacity: 1.0,
          userOpacity: null,
          isVisible: true,
          isOpaque: true,
          parentModel: archModel
        },
        {
          id: "09e623d4-1e12-4a77-b358-ea1d0b28e4a7",
          name: "Rooms",
          opacity: 1.0,
          userOpacity: null,
          isVisible: false,
          isOpaque: true,
          parentModel: archModel
        },
        {
          id: "30114b52-bc05-47c1-80b5-c7d5485d5840",
          name: "Finish",
          opacity: 1.0,
          userOpacity: null,
          isVisible: true,
          isOpaque: true,
          parentModel: archModel
        }
      ];

      // Assign layers to the architectural model
      archModel.layers = archModelLayers;
      archModel.isSemiVisible = archModelLayers.some((layer) => !layer.isVisible); // Check if any layer is not visible to set semi-visible state

      let structModel = {
        id: "550e8400-e29b-41d4-a716-446655440003",
        name: "Structural Model",
        currentRevision: 2,
        latestRevision: 2,
        isExpanded: false,
        divisionTopologyId: "550e8400-e29b-41d4-a716-446655440004",
        isVisible: true,
        opacity: 0.8,
        userOpacity: 0.6,
        isOpaque: true
      };

      let structModelLayers = [
        {
          id: "dd5cc7d0-72fe-46aa-ba62-dcd86729bd2f",
          name: "Reinforcement Layer",
          opacity: 1.0,
          userOpacity: null,
          isVisible: true,
          isOpaque: true,
          parentModel: structModel
        },
        {
          id: "d625ce34-b38c-4c97-b663-3e4f26e301c8",
          name: "Steel Design",
          opacity: 1.0,
          userOpacity: null,
          isVisible: true,
          isOpaque: true,
          parentModel: structModel
        },
        {
          id: "30114b52-bc05-47c1-80b5-c7d5485d5831",
          name: "General Objects",
          opacity: 1.0,
          userOpacity: null,
          isVisible: true,
          isOpaque: true,
          parentModel: structModel
        },
        {
          id: "72b7e0ba-ae1a-4a71-b1ec-ad8f553fb3bc",
          name: "Project Connection",
          opacity: 1.0,
          userOpacity: null,
          isVisible: false,
          isOpaque: true,
          parentModel: structModel
        }
      ];
      // Assign layers to the structural model
      structModel.layers = structModelLayers;
      structModel.isSemiVisible = structModelLayers.some((layer) => !layer.isVisible); // Check if any layer is not visible to set semi-visible state

      let projectData = {
        id: "550e8400-e29b-41d4-a716-446655440000",
        name: "Office Building Project",
        teamSlug: "construction-team-alpha",
        models: [
          archModel,
          structModel
        ]
      };

      projectNavigatorFloatingBar.project = projectData;

      // Opacity constants for managing transparency states
      let defaultOpacity = 1.0; // Full opacity (completely opaque)
      let transparentOpacity = 0.5; // Semi-transparent opacity value

      /**
       * Updates model visibility and semi-visible state based on its layers
       * @param {Object} model - The model object to update
       */
      function updateModelVisibilityState(model) {
        const countInvisibleLayers = model.layers.filter((l) => !l.isVisible).length;
        if (countInvisibleLayers === model.layers.length) { 
          // All layers are invisible - hide the entire model
          model.isVisible = false;
          model.isSemiVisible = false;
          console.log(`Model ${model.name} visibility set to false because all layers are invisible`);
        } else {
          // At least one layer is visible - show the model
          model.isVisible = true;
          // Set semi-visible state if some (but not all) layers are invisible
          model.isSemiVisible = countInvisibleLayers > 0;
          console.log(`Model ${model.name} visibility set to true because at least one layer is visible`);
        }
      }

      /**
       * Updates model opacity and semi-opaque state based on its layers
       * @param {Object} model - The model object to update
       */
      function updateModelOpacityState(model) {
        const countTransparentLayers = model.layers.filter((l) => !l.isOpaque).length;
        if (countTransparentLayers === model.layers.length) {
          // All layers are transparent - set model to transparent
          model.isOpaque = false;
          model.isSemiOpaque = false;
          console.log(`Model ${model.name} opacity set to false because all layers are transparent`);
        } else {
          // At least one layer is opaque - set model to opaque
          model.isOpaque = true;
          // Set semi-opaque state if some (but not all) layers are transparent
          model.isSemiOpaque = countTransparentLayers > 0;
          console.log(`Model ${model.name} opacity set to true because at least one layer is opaque`);
        }
      }

      /**
       * Synchronizes all layers in a model to match the model's visibility state
       * @param {Object} model - The model whose layers should be synchronized
       */
      function syncLayersVisibility(model) {
        model.layers.forEach((layer) => {
          layer.isVisible = model.isVisible; // Sync layer visibility with parent model
          console.log(`Layer ${layer.name} visibility set to ${layer.isVisible}`);
        });
      }

      /**
       * Synchronizes all layers in a model to match the model's opacity state
       * @param {Object} model - The model whose layers should be synchronized
       */
      function syncLayersOpacity(model) {
        model.layers.forEach((layer) => {
          layer.isOpaque = model.isOpaque; // Sync layer opacity state with parent model
          // Update the actual opacity value based on the opaque state
          layer.opacity = layer.isOpaque ? defaultOpacity : transparentOpacity;
        });
      }

      /**
       * Finds a model by ID from the project data
       * @param {string} modelId - The ID of the model to find
       * @returns {Object|undefined} The model object or undefined if not found
       */
      function findModelById(modelId) {
        return projectData.models.find((m) => m.id === modelId);
      }

      /**
       * Finds a layer by ID within a specific model
       * @param {Object} model - The model to search within
       * @param {string} layerId - The ID of the layer to find
       * @returns {Object|undefined} The layer object or undefined if not found
       */
      function findLayerById(model, layerId) {
        return model.layers.find((l) => l.id === layerId);
      }

      // Event handler for toggling visibility of entire models
      // When a model's visibility is toggled, all its layers inherit the same visibility state
      projectNavigatorFloatingBar.addEventListener("toggleVisibilityOfModel", (event) => {
        console.dir(event);
        const model = findModelById(event.detail.id);
        if (model) {
          model.isVisible = !model.isVisible; // Toggle the model's visibility state
          model.isSemiVisible = false; // Reset semi-visible state when explicitly toggling model
          console.log(`Model ${model.name} visibility toggled to ${model.isVisible}`);

          // Synchronize all layers within the model to match the model's visibility
          syncLayersVisibility(model);
        }
      });

      // Event handler for toggling visibility of individual layers within a model
      // This also manages the parent model's visibility and semi-visible states
      projectNavigatorFloatingBar.addEventListener("toggleVisibilityOfLayer", (event) => {
        console.dir(event);
        const model = findModelById(event.detail.parentModel.id);
        if (model) {
          const layer = findLayerById(model, event.detail.id);
          if (layer) {
            layer.isVisible = !layer.isVisible; // Toggle the individual layer's visibility
            console.log(`Layer ${layer.name} visibility toggled to ${layer.isVisible}`);
          }

          // Update model visibility based on layer states
          updateModelVisibilityState(model);
        }
      });

      // Event handler for toggling opacity of entire models
      // When a model's opacity is toggled, all its layers inherit the same opacity state
      projectNavigatorFloatingBar.addEventListener("toggleOpacityOfModel", (event) => {
        console.dir(event);
        const model = findModelById(event.detail.id);
        if (model) {
          model.isOpaque = !model.isOpaque; // Toggle the model's opacity state
          model.isSemiOpaque = false; // Reset semi-opaque state when explicitly toggling model

          // Synchronize all layers within the model to match the model's opacity
          syncLayersOpacity(model);
        }
      });

      // Event handler for toggling opacity of individual layers within a model
      // This also manages the parent model's opacity and semi-opaque states
      projectNavigatorFloatingBar.addEventListener("toggleOpacityOfLayer", (event) => {
        console.dir(event);
        const model = findModelById(event.detail.parentModel.id);
        if (model) {
          const layer = findLayerById(model, event.detail.id);
          if (layer) {
            layer.isOpaque = !layer.isOpaque; // Toggle the individual layer's opacity state
            // Update the actual opacity value based on the new opaque state
            layer.opacity = layer.isOpaque ? defaultOpacity : transparentOpacity;
          }

          // Update model opacity state based on layer opacity states
          updateModelOpacityState(model);
        }
      });

      projectNavigatorFloatingBar.expandedModelTree = true; // Set to true to show the expanded model tree by default

      // #endregion

      const contextMenu = document.querySelector("bimplus-context-menu");
      contextMenu.items = [
        {
          id: "openFile",
          title: "Open file",
          icon: "./assets/images/document.svg",
          tooltip: "Open file tooltip",
        },
        {
          id: "separator",
        },
        {
          id: "closeFile",
          title: "Close file",
          icon: "./assets/images/cross.svg",
          disabled: (data) => {
            return true;
          },
        },
        {
          id: "deleteFile",
          title: "Delete file",
          icon: "./assets/images/trash.svg",
        },
        {
          id: "separator",
        },
        {
          id: "renameFile",
          title: "Rename file",
          icon: "./assets/images/edit.svg",
          action: (data) => {
            console.log(data);
          },
          tooltip: "Rename file tooltip",
        },
        {
          id: "renameFile",
          title:
            "Looooooooooooooooooooooooooooooooooooooooooooooooooooong item name",
          icon: "./assets/images/document.svg",
          action: (data) => {
            console.log(data);
          },
          tooltip:
            "Looooooooooooooooooooooooooooooooooooooooooooooooooooong item name",
        },
      ];
      contextMenu.data = [
        {
          name: "Folder 5",
          id: "dbc08cd2-9f50-465b-9b54-da29c4988d07-23",
          parent: "dbc08cd2-9f50-465b-9b54-da29c4988d07-00",
          children: [
            {
              name: "File 3 - 3 - 3",
              id: "dbc08cd2-9f50-465b-9b54-da29c4988d07-24",
              parent: "dbc08cd2-9f50-465b-9b54-da29c4988d07-23",
            },
          ],
        },
      ];

      const flatTree = document.querySelector("bimplus-flat-tree");
      flatTree.contextMenus = {
        objectContextMenuitems: [
          {
            id: "openFile",
            title: "Open file",
            icon: "./assets/images/document.svg",
            tooltip: "Open file tooltip",
            disabled: true,
          },
          {
            id: "separator",
          },
          {
            id: "closeFile",
            title: "Close file",
            icon: "./assets/images/cross.svg",
            disabled: (data) => {
              return true;
            },
          },
          {
            id: "deleteFile",
            title: "Delete file",
            icon: "./assets/images/trash.svg",
            disabled: (data) => {
              return false;
            },
          },
          {
            id: "separator",
          },
          {
            id: "renameFile",
            title: "Rename file",
            icon: "./assets/images/edit.svg",
            action: (data) => {
              console.log(data);
            },
            tooltip: "Rename file tooltip",
          },
        ],
        folderContextMenuitems: [
          {
            id: "renameFolder",
            title: "Rename folder",
            icon: "./assets/images/document.svg",
            tooltip: "Rename folder tooltip",
          },
          {
            id: "deletFolder",
            title: "Delete folder",
            tooltip: "Delete folder tooltip",
          },
        ],
      };
    </script>
  </body>
</html>
